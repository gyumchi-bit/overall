<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub API 설정 - MBTI 분석</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
        }
        .navbar {
            background-color: rgba(0,0,0,0.1) !important;
        }
        .settings-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .settings-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .header-title {
            color: white;
            text-align: center;
            margin-bottom: 2rem;
        }
        .security-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .security-warning i {
            color: #856404;
        }
        .api-status {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            text-align: center;
        }
        .api-status.connected {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .api-status.disconnected {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .form-group {
            margin-bottom: 2rem;
        }
        .input-group {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            z-index: 10;
            color: #6c757d;
        }
        .token-input {
            padding-right: 45px;
        }
        .feature-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .feature-item i {
            color: #28a745;
            margin-right: 1rem;
            width: 20px;
        }
        .test-section {
            background: #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        .btn-github {
            background: #24292e;
            border-color: #24292e;
            color: white;
        }
        .btn-github:hover {
            background: #1a1e22;
            border-color: #1a1e22;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-brain me-2"></i>MBTI 분석
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">홈</a></li>
                    <li class="nav-item"><a class="nav-link" href="test.html">테스트</a></li>
                    <li class="nav-item"><a class="nav-link" href="career-test.html">진로 탐색</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">분석 도구</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="type-search.html">성격유형 검색기</a></li>
                            <li><a class="dropdown-item" href="mbti-calculator.html">MBTI 점수 계산기</a></li>
                            <li><a class="dropdown-item" href="type-comparison.html">유형 비교 도구</a></li>
                            <li><a class="dropdown-item" href="text-counter.html">글자수 세기</a></li>
                            <li><a class="dropdown-item" href="quick-personality.html">빠른 성격 분석</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link active" href="github-settings.html">GitHub 설정</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="settings-container">
        <!-- Header -->
        <div class="header-title">
            <h1><i class="fab fa-github me-3"></i>GitHub API 설정</h1>
            <p class="lead">GitHub 연동을 위한 안전한 API 토큰 관리</p>
        </div>

        <!-- Security Warning -->
        <div class="security-warning">
            <h5><i class="fas fa-shield-alt me-2"></i>보안 안내</h5>
            <ul class="mb-0">
                <li>API 토큰은 브라우저 로컬 스토리지에 암호화되어 저장됩니다</li>
                <li>토큰은 절대 서버로 전송되지 않으며, 클라이언트에서만 사용됩니다</li>
                <li>페이지를 새로고침하거나 브라우저를 닫으면 메모리에서 자동 삭제됩니다</li>
                <li>토큰 삭제 시 모든 저장된 정보가 완전히 제거됩니다</li>
            </ul>
        </div>

        <!-- API Status -->
        <div class="api-status disconnected" id="apiStatus">
            <i class="fas fa-times-circle me-2"></i>
            <span id="statusText">GitHub API 연결되지 않음</span>
        </div>

        <!-- Settings Card -->
        <div class="settings-card">
            <h3><i class="fas fa-cog me-2"></i>API 토큰 설정</h3>
            
            <!-- GitHub Token Input -->
            <div class="form-group">
                <label for="githubToken" class="form-label">
                    <i class="fab fa-github me-2"></i>GitHub Personal Access Token
                </label>
                <div class="input-group">
                    <input 
                        type="password" 
                        class="form-control token-input" 
                        id="githubToken" 
                        placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                        autocomplete="off"
                    >
                    <i class="fas fa-eye password-toggle" id="toggleToken" onclick="toggleTokenVisibility()"></i>
                </div>
                <div class="form-text">
                    <a href="https://github.com/settings/tokens" target="_blank" class="text-decoration-none">
                        <i class="fas fa-external-link-alt me-1"></i>GitHub에서 토큰 생성하기
                    </a>
                </div>
            </div>

            <!-- Repository Settings -->
            <div class="form-group">
                <label for="repositoryUrl" class="form-label">
                    <i class="fas fa-code-branch me-2"></i>Repository URL (선택사항)
                </label>
                <input 
                    type="url" 
                    class="form-control" 
                    id="repositoryUrl" 
                    placeholder="https://github.com/username/repository"
                >
                <div class="form-text">테스트 결과나 데이터를 저장할 GitHub 저장소</div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-3 flex-wrap">
                <button class="btn btn-github" onclick="saveSettings()">
                    <i class="fas fa-save me-2"></i>설정 저장
                </button>
                <button class="btn btn-success" onclick="testConnection()">
                    <i class="fas fa-plug me-2"></i>연결 테스트
                </button>
                <button class="btn btn-danger" onclick="clearSettings()">
                    <i class="fas fa-trash me-2"></i>설정 삭제
                </button>
            </div>

            <!-- Test Section -->
            <div class="test-section" id="testSection" style="display: none;">
                <h5><i class="fas fa-vial me-2"></i>API 테스트 결과</h5>
                <div id="testResults"></div>
            </div>

            <!-- Features -->
            <div class="feature-list">
                <h5><i class="fas fa-star me-2"></i>GitHub 연동 기능</h5>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>테스트 결과 GitHub Gist로 저장</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>MBTI 분석 데이터 백업</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>개인 진로 분석 히스토리 저장</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>사용자 맞춤 설정 동기화</span>
                </div>
            </div>

            <!-- Token Permissions -->
            <div class="mt-4">
                <h5><i class="fas fa-key me-2"></i>필요한 토큰 권한</h5>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-dot-circle me-2 text-primary"></i>gist (Gist 생성/수정)</li>
                            <li><i class="fas fa-dot-circle me-2 text-primary"></i>repo (저장소 접근)</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-dot-circle me-2 text-secondary"></i>user:email (이메일 확인)</li>
                            <li><i class="fas fa-dot-circle me-2 text-secondary"></i>read:user (사용자 정보)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 암호화/복호화를 위한 간단한 함수들
        class SecureStorage {
            static encryptData(data) {
                // 간단한 Base64 인코딩 (실제 프로덕션에서는 더 강력한 암호화 필요)
                return btoa(JSON.stringify(data));
            }

            static decryptData(encryptedData) {
                try {
                    return JSON.parse(atob(encryptedData));
                } catch (e) {
                    return null;
                }
            }

            static saveSecure(key, data) {
                const encrypted = this.encryptData(data);
                localStorage.setItem(key, encrypted);
            }

            static loadSecure(key) {
                const encrypted = localStorage.getItem(key);
                return encrypted ? this.decryptData(encrypted) : null;
            }
        }

        class GitHubAPIManager {
            constructor() {
                this.token = null;
                this.repositoryUrl = null;
                this.loadSettings();
                this.updateStatus();
            }

            loadSettings() {
                const settings = SecureStorage.loadSecure('github_api_settings');
                if (settings) {
                    this.token = settings.token;
                    this.repositoryUrl = settings.repositoryUrl;
                    
                    document.getElementById('githubToken').value = this.token || '';
                    document.getElementById('repositoryUrl').value = this.repositoryUrl || '';
                }
            }

            saveSettings() {
                const token = document.getElementById('githubToken').value.trim();
                const repositoryUrl = document.getElementById('repositoryUrl').value.trim();

                if (!token) {
                    alert('GitHub 토큰을 입력해주세요.');
                    return;
                }

                // 토큰 형식 검증
                if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                    if (!confirm('입력한 토큰이 GitHub Personal Access Token 형식이 아닐 수 있습니다. 계속하시겠습니까?')) {
                        return;
                    }
                }

                const settings = {
                    token: token,
                    repositoryUrl: repositoryUrl,
                    savedAt: new Date().toISOString()
                };

                SecureStorage.saveSecure('github_api_settings', settings);
                
                this.token = token;
                this.repositoryUrl = repositoryUrl;
                
                this.updateStatus();
                
                alert('GitHub API 설정이 안전하게 저장되었습니다.');
            }

            async testConnection() {
                if (!this.token) {
                    alert('먼저 GitHub 토큰을 설정해주세요.');
                    return;
                }

                const testSection = document.getElementById('testSection');
                const testResults = document.getElementById('testResults');
                
                testSection.style.display = 'block';
                testResults.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>연결 테스트 중...';

                try {
                    // GitHub API 사용자 정보 요청
                    const response = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        testResults.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>연결 성공!</strong><br>
                                사용자: ${userData.login} (${userData.name || 'N/A'})<br>
                                API 요청 제한: ${response.headers.get('x-ratelimit-remaining')}/${response.headers.get('x-ratelimit-limit')}
                            </div>
                        `;
                        this.updateStatus(true);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        testResults.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle me-2"></i>
                                <strong>연결 실패!</strong><br>
                                오류: ${errorData.message || '인증 실패'}
                            </div>
                        `;
                        this.updateStatus(false);
                    }
                } catch (error) {
                    testResults.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            <strong>연결 오류!</strong><br>
                            ${error.message}
                        </div>
                    `;
                    this.updateStatus(false);
                }
            }

            clearSettings() {
                if (confirm('모든 GitHub API 설정을 삭제하시겠습니까?')) {
                    localStorage.removeItem('github_api_settings');
                    this.token = null;
                    this.repositoryUrl = null;
                    
                    document.getElementById('githubToken').value = '';
                    document.getElementById('repositoryUrl').value = '';
                    document.getElementById('testSection').style.display = 'none';
                    
                    this.updateStatus();
                    alert('GitHub API 설정이 삭제되었습니다.');
                }
            }

            updateStatus(connected = null) {
                const statusElement = document.getElementById('apiStatus');
                const statusText = document.getElementById('statusText');
                
                if (connected === null) {
                    connected = !!this.token;
                }
                
                if (connected) {
                    statusElement.className = 'api-status connected';
                    statusText.innerHTML = '<i class="fas fa-check-circle me-2"></i>GitHub API 연결됨';
                } else {
                    statusElement.className = 'api-status disconnected';
                    statusText.innerHTML = '<i class="fas fa-times-circle me-2"></i>GitHub API 연결되지 않음';
                }
            }

            // GitHub API 사용을 위한 헬퍼 메서드들
            async createGist(title, content, isPublic = false) {
                if (!this.token) {
                    throw new Error('GitHub 토큰이 설정되지 않았습니다.');
                }

                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: title,
                        public: isPublic,
                        files: {
                            [`${title}.md`]: {
                                content: content
                            }
                        }
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Gist 생성 실패');
                }

                return await response.json();
            }

            async saveTestResult(testType, result) {
                try {
                    const content = `# MBTI ${testType} 결과

## 분석 결과
- **유형**: ${result.type}
- **테스트 날짜**: ${new Date().toLocaleString('ko-KR')}

## 상세 점수
${Object.entries(result.scores).map(([key, value]) => `- ${key}: ${value}`).join('\n')}

## 답변 내역
${Object.entries(result.answers).map(([key, value]) => `**문항 ${key}**: ${value.text || value.value}`).join('\n')}

---
*이 결과는 MBTI 분석 사이트에서 자동 생성되었습니다.*
`;

                    const gist = await this.createGist(`MBTI ${testType} 결과 - ${result.type}`, content, false);
                    return gist.html_url;
                } catch (error) {
                    console.error('GitHub 저장 오류:', error);
                    throw error;
                }
            }
        }

        // 전역 GitHub API 매니저 인스턴스
        const githubAPI = new GitHubAPIManager();

        // UI 헬퍼 함수들
        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('githubToken');
            const toggleIcon = document.getElementById('toggleToken');
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash password-toggle';
            } else {
                tokenInput.type = 'password';
                toggleIcon.className = 'fas fa-eye password-toggle';
            }
        }

        function saveSettings() {
            githubAPI.saveSettings();
        }

        function testConnection() {
            githubAPI.testConnection();
        }

        function clearSettings() {
            githubAPI.clearSettings();
        }

        // 다른 페이지에서 사용할 수 있도록 전역 함수 노출
        window.GitHubAPI = githubAPI;
    </script>
</body>
</html>